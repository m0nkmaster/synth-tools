# Implementation Plan

- [x] 1. Create core UI components
  - [x] 1.1 Implement Knob component with rotation gesture and value display
    - Create circular knob with drag interaction
    - Add value display and unit labels
    - Support logarithmic scaling for frequency parameters
    - _Requirements: 9.5_
  - [x] 1.2 Implement Switch component for boolean parameters
    - Create toggle switch with visual states
    - _Requirements: 9.2_
  - [x] 1.3 Implement SegmentedButton component for discrete selections
    - Create multi-option selector with visual feedback
    - _Requirements: 9.3_
  - [x] 1.4 Implement EnvelopeVisualizer component
    - Create SVG-based ADSR curve visualization
    - Calculate curve points from envelope parameters
    - _Requirements: 2.5_
  - [x] 1.5 Write property test for EnvelopeVisualizer
    - **Property 12: Envelope Visualization**
    - **Validates: Requirements 2.5**

- [x] 2. Implement parameter validation and clamping utilities
  - [x] 2.1 Create parameter clamping function
    - Implement clamping logic for numeric parameters
    - Support min/max bounds
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.2, 3.3, 4.2, 4.3, 4.5, 6.3, 7.5, 11.2, 11.3, 11.4, 12.2, 12.3, 12.4_
  - [x] 2.2 Create JSON validation utilities
    - Implement syntax validation
    - Implement schema validation
    - Implement range validation
    - _Requirements: 15.4, 15.5_
  - [x] 2.3 Write property test for parameter clamping
    - **Property 1: Parameter Clamping**
    - **Validates: Requirements 2.1, 2.2, 2.3, 2.4, 3.2, 3.3, 4.2, 4.3, 4.5, 6.3, 7.5, 11.2, 11.3, 11.4, 12.2, 12.3, 12.4**
  - [x] 2.4 Write property test for JSON validation
    - **Property 10: Invalid JSON Rejection**
    - **Property 11: Value Clamping on JSON Import**
    - **Validates: Requirements 15.4, 15.5**

- [x] 3. Implement preset management system
  - [x] 3.1 Create preset storage utilities
    - Implement localStorage read/write functions
    - Handle storage errors and quota exceeded
    - _Requirements: 8.1, 8.4_
  - [x] 3.2 Create PresetManager component
    - Implement preset save dialog
    - Implement preset load functionality
    - Implement preset delete functionality
    - _Requirements: 8.1, 8.2, 8.3, 8.4_
  - [x] 3.3 Implement default preset loading on initialization
    - Load default preset on mount
    - _Requirements: 8.5_
  - [x] 3.4 Write property test for preset round-trip
    - **Property 4: Preset Round-Trip**
    - **Validates: Requirements 8.2**
  - [x] 3.5 Write property test for preset deletion
    - **Property 15: Preset Deletion**
    - **Validates: Requirements 8.4**

- [x] 4. Implement layer management
  - [x] 4.1 Create LayerManager component
    - Implement layer list display
    - Implement add layer button with type selection
    - Implement remove layer functionality
    - _Requirements: 1.1, 1.2, 1.5_
  - [x] 4.2 Create OscillatorControls component
    - Implement waveform selector
    - Implement frequency, detune controls
    - Implement unison controls (voices, detune, spread)
    - Implement sub-oscillator controls
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_
  - [x] 4.3 Create NoiseControls component
    - Implement noise type selector
    - Implement gain control
    - _Requirements: 10.1, 10.2, 10.4_
  - [x] 4.4 Create FMControls component
    - Implement carrier frequency control
    - Implement modulator frequency control
    - Implement modulation index control
    - Implement gain control
    - _Requirements: 11.1, 11.2, 11.3, 11.4, 11.5_
  - [x] 4.5 Create KarplusStrongControls component
    - Implement frequency control
    - Implement damping control
    - Implement pluck location control
    - Implement gain control
    - _Requirements: 12.1, 12.2, 12.3, 12.4, 12.5_
  - [x] 4.6 Create LayerControls component with dynamic rendering
    - Render appropriate controls based on layer type
    - Implement layer envelope controls
    - Implement layer filter controls
    - Implement saturation controls
    - _Requirements: 1.3, 1.4, 10.3, 10.5_
  - [x] 4.7 Write property test for layer addition
    - **Property 5: Layer Addition**
    - **Validates: Requirements 1.2**
  - [x] 4.8 Write property test for layer removal
    - **Property 6: Layer Removal**
    - **Validates: Requirements 1.5**
  - [x] 4.9 Write property test for layer type controls
    - **Property 14: Layer Type Controls**
    - **Validates: Requirements 1.3**

- [x] 5. Create main SynthesizerUI page component
  - [x] 5.1 Implement SynthesizerUI component structure
    - Set up state management for SoundConfig using useState
    - Create basic layout with placeholder sections for all panels
    - Integrate existing LayerManager component
    - Integrate existing PresetManager component
    - Add basic styling and layout structure
    - _Requirements: 1.1, 8.1, 8.2, 8.3_
  - [x] 5.2 Add route for SynthesizerUI page
    - Update router configuration in main.tsx
    - Add navigation link from main menu
    - Replace SynthTest route with SynthesizerUI route
  - [x] 5.3 Implement basic playback controls
    - Add play button that calls synthesizeSound with current config
    - Add duration control using Knob component
    - Handle playback state (playing/stopped)
    - Display basic error messages if synthesis fails
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 6. Implement global synthesis controls
  - [x] 6.1 Create GlobalEnvelopeControls component
    - Implement ADSR controls (attack, decay, sustain, release) using Knob components
    - Integrate EnvelopeVisualizer to display envelope curve
    - Wire up state updates to global envelope in SoundConfig
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_
  - [x] 6.2 Create FilterPanel component
    - Implement filter type selector using SegmentedButton
    - Implement cutoff and resonance controls using Knob components
    - Implement gain control for peaking filter
    - Implement filter envelope controls (ADSR + amount)
    - Wire up state updates to global filter in SoundConfig
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_
  - [x] 6.3 Create LFOPanel component
    - Implement LFO enable toggle using Switch
    - Implement waveform selector using SegmentedButton
    - Implement frequency and depth controls using Knob components
    - Implement target selector using SegmentedButton
    - Implement delay and fade controls using Knob components
    - Wire up state updates to LFO in SoundConfig
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 7. Implement effects controls
  - [x] 7.1 Create EffectsPanel component structure
    - Create collapsible/expandable sections for each effect type
    - Each effect should have an enable toggle
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_
  - [x] 7.2 Implement ReverbControls
    - Implement decay, damping, and mix controls using Knob components
    - Wire up state updates to effects.reverb in SoundConfig
    - _Requirements: 5.1_
  - [x] 7.3 Implement DelayControls
    - Implement time, feedback, and mix controls using Knob components
    - Wire up state updates to effects.delay in SoundConfig
    - _Requirements: 5.2_
  - [x] 7.4 Implement DistortionControls
    - Implement type selector using SegmentedButton
    - Implement amount and mix controls using Knob components
    - Wire up state updates to effects.distortion in SoundConfig
    - _Requirements: 5.3_
  - [x] 7.5 Implement CompressorControls
    - Implement threshold, ratio, attack, release, and knee controls using Knob components
    - Wire up state updates to effects.compressor in SoundConfig
    - _Requirements: 5.4_
  - [x] 7.6 Implement GateControls
    - Implement attack, hold, and release controls using Knob components
    - Wire up state updates to effects.gate in SoundConfig
    - _Requirements: 5.5_

- [x] 8. Implement metadata and export controls
  - [x] 8.1 Create MetadataPanel component
    - Implement name input using TextField
    - Implement category selector using SegmentedButton or Select
    - Implement description input using TextField
    - Implement tags input with add/remove functionality
    - Wire up state updates to metadata in SoundConfig
    - _Requirements: 13.1, 13.2, 13.3, 13.4, 13.5_
  - [x] 8.2 Implement export functionality
    - Create export button in PlaybackPanel or separate ExportPanel
    - Implement audio file generation using synthesizeSound
    - Implement download trigger using blob URL
    - Handle export errors with user-friendly messages
    - Use metadata name for filename
    - _Requirements: 14.1, 14.2, 14.3, 14.4, 14.5_
  - [x] 8.3 Write property test for tag management
    - **Property 7: Tag Management**
    - **Validates: Requirements 13.4, 13.5**
  - [x] 8.4 Write property test for synthesis success
    - **Property 8: Synthesis Success**
    - **Validates: Requirements 7.1**
  - [x] 8.5 Write property test for export filename
    - **Property 9: Export Filename**
    - **Validates: Requirements 14.5**
  - [x] 8.6 Write property test for discrete parameter updates
    - **Property 13: Discrete Parameter Updates**
    - **Validates: Requirements 3.1, 4.1, 6.2, 6.4, 10.1, 13.2**

- [x] 9. Implement JSON editor integration
  - [x] 9.1 Add Monaco Editor dependency and create JSONEditor component
    - Install @monaco-editor/react using bun
    - Create JSONEditor component wrapper with syntax highlighting
    - Configure JSON language mode and validation
    - _Requirements: 15.1_
  - [x] 9.2 Implement bidirectional JSON-UI synchronization
    - Add JSON state derived from SoundConfig
    - Parse JSON changes using validateSoundConfigJSON
    - Update SoundConfig state when JSON is valid
    - Serialize SoundConfig to JSON when UI controls change
    - _Requirements: 15.2, 15.3_
  - [x] 9.3 Implement validation error display
    - Show syntax errors with line/column info
    - Show schema validation errors
    - Show range validation warnings
    - Use existing validation utilities from src/utils/validation.ts
    - _Requirements: 15.4, 15.5_
  - [x] 9.4 Integrate JSON editor into SynthesizerUI layout
    - Add collapsible JSON editor panel to the UI
    - Wire up bidirectional synchronization handlers
    - Add toggle button to show/hide JSON editor
    - _Requirements: 15.1, 15.2, 15.3_
  - [ ]* 9.5 Write property test for JSON-to-UI synchronization
    - **Property 2: JSON-to-UI Synchronization**
    - **Validates: Requirements 15.2**
  - [ ]* 9.6 Write property test for UI-to-JSON synchronization
    - **Property 3: UI-to-JSON Synchronization**
    - **Validates: Requirements 15.3**

- [x] 10. Polish and error handling
  - [x] 10.1 Implement error boundaries
    - Create ErrorBoundary component for synthesis errors
    - Wrap SynthesizerUI with error boundary
    - Display user-friendly error messages with recovery options
    - _Requirements: 7.4, 14.4_
  - [x] 10.2 Enhance loading states and feedback
    - Verify loading indicators work during synthesis
    - Verify loading indicators work during export
    - Add visual feedback for control interactions (hover states, active states)
    - Test error display for synthesis and export failures

- [x] 11. Final checkpoint - Ensure all tests pass
  - Run `bun test` to verify all tests pass
  - Run `bun run lint` to verify code quality
  - Ask the user if questions arise
